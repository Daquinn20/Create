name: Daily Estimates Tracker

on:
  schedule:
    # Run at 6 AM ET (11 AM UTC) every day
    - cron: '0 11 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  capture-estimates:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      FMP_API_KEY: ${{ secrets.FMP_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Full history for proper merging

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install pandas openpyxl requests python-dotenv

      - name: Debug - Check API key
        run: |
          if [ -z "$FMP_API_KEY" ]; then
            echo "ERROR: FMP_API_KEY is empty or not set"
            exit 1
          else
            echo "FMP_API_KEY is set (length: ${#FMP_API_KEY} chars)"
          fi

      - name: Pull latest changes before running
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git pull origin master --rebase || git pull origin main --rebase || true
          echo "Pulled latest changes"

      - name: Check database before
        run: |
          echo "=== Database status BEFORE tracker ==="
          if [ -f estimates_history.db ]; then
            ls -la estimates_history.db
            echo "File exists, size: $(stat -c%s estimates_history.db) bytes"
          else
            echo "Database does not exist yet"
          fi

      - name: Run estimates tracker
        run: |
          python estimates_tracker.py --universe master

      - name: Show status
        run: |
          python estimates_tracker.py --status

      - name: Check database after
        run: |
          echo "=== Database status AFTER tracker ==="
          ls -la estimates_history.db
          echo "File size: $(stat -c%s estimates_history.db) bytes"

      - name: Commit and push database
        run: |
          # Force add the database (binary files need this)
          git add -f estimates_history.db

          # Debug: show git status
          echo "=== Git status ==="
          git status

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes detected in database"
          else
            echo "Changes detected, committing..."
            git commit -m "Daily estimates snapshot $(date +'%Y-%m-%d')"

            # Push with retry logic
            for i in 1 2 3; do
              echo "Push attempt $i..."
              if git push; then
                echo "Push successful!"
                break
              else
                echo "Push failed, pulling and retrying..."
                git pull --rebase origin master || git pull --rebase origin main || true
              fi
            done
          fi
