name: Daily Estimates Tracker (Test Run)

on:
  schedule:
    # Run at 6 AM ET (11 AM UTC) every day
    - cron: '0 11 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  test-tracker:
    runs-on: ubuntu-latest
    env:
      FMP_API_KEY: ${{ secrets.FMP_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install pandas openpyxl requests python-dotenv

      - name: Check API key
        run: |
          if [ -z "$FMP_API_KEY" ]; then
            echo "ERROR: FMP_API_KEY is empty or not set"
            exit 1
          else
            echo "FMP_API_KEY is set (length: ${#FMP_API_KEY} chars)"
          fi

      - name: Run estimates tracker (test with 10 stocks)
        run: |
          echo "Running test scan with 10 stocks to verify tracker works..."
          python -c "
          from estimates_tracker import EstimatesTracker, get_master_universe_tickers
          tracker = EstimatesTracker()
          tickers = get_master_universe_tickers()[:10]
          print(f'Testing with {len(tickers)} tickers: {tickers}')
          tracker.capture_daily_snapshot(tickers, max_workers=5)
          tracker.print_status()
          "

      - name: Test complete
        run: |
          echo "============================================"
          echo "GitHub Actions test run complete!"
          echo "Note: Database is NOT persisted in GitHub."
          echo "Production data collection runs locally via"
          echo "Windows Task Scheduler with OneDrive backup."
          echo "============================================"
